<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">

<head>
<meta charset="UTF-8">
<title>Game Library</title>
</head>

<body>
	<section>
		<div class="container" style="margin-top: 80px; margin-bottom: 60px;">

			<!-- Header -->
			<div class="text-center mb-4">
				<h2 class="fw-bold"><i class="fa-solid fa-gamepad me-2"></i>My Game Library</h2>
				<p class="text-muted">All your purchased games in one place</p>
			</div>

			<!-- üîê AES-256 Security Info Banner -->
			<div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 12px;">
				<div class="d-flex align-items-center">
					<div class="me-3">
						<i class="fa-solid fa-shield-halved fa-2x text-primary"></i>
					</div>
					<div>
						<h6 class="mb-1 fw-bold"><i class="fa-solid fa-lock me-1"></i> Secure Digital Delivery (AES-256)</h6>
						<small class="text-muted">
							‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏°‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô AES-256 (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£) 
							‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ <strong>License Key</strong> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå
						</small>
					</div>
				</div>
			</div>

			<!-- Success/Error Messages -->
			<th:block th:if="${session.succMsg}">
				<div class="alert alert-success text-center" role="alert">
					[[${session.succMsg}]]
				</div>
				<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
			</th:block>
			<th:block th:if="${session.errorMsg}">
				<div class="alert alert-danger text-center" role="alert">
					[[${session.errorMsg}]]
				</div>
				<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
			</th:block>

			<!-- Games Count Badge -->
			<div class="mb-4">
				<span class="badge bg-primary fs-6">
					<i class="fa-solid fa-layer-group me-1"></i> [[${gamesCount}]] Game(s) in Library
				</span>
			</div>

			<!-- Empty Library -->
			<th:block th:if="${games == null or games.isEmpty()}">
				<div class="text-center py-5">
					<div class="mb-4">
						<i class="fa-solid fa-ghost fa-5x text-muted"></i>
					</div>
					<h4 class="text-muted mb-3">Your Library is Empty</h4>
					<p class="text-muted mb-4">Purchase games from our store to see them here!</p>
					<a href="/products" class="btn btn-primary btn-lg">
						<i class="fa-solid fa-store me-2"></i>Browse Games
					</a>
				</div>
			</th:block>

			<!-- Game Cards -->
			<div class="row g-4" th:if="${games != null and !games.isEmpty()}">
				<div class="col-lg-4 col-md-6" th:each="game : ${games}">
					<div class="card h-100 shadow-sm border-0" style="border-radius: 12px; overflow: hidden;">
						<!-- Game Image -->
						<div class="position-relative">
							<img th:src="${game.product.image}" class="card-img-top"
								th:alt="${game.product.title}"
								style="height: 220px; object-fit: cover;">
							<!-- Owned Badge -->
							<span class="badge bg-success position-absolute top-0 end-0 m-2">
								<i class="fa-solid fa-check-circle me-1"></i> Owned
							</span>
							<!-- AES-256 Badge -->
							<span class="badge bg-dark position-absolute top-0 start-0 m-2" style="opacity: 0.85;">
								<i class="fa-solid fa-lock me-1"></i> AES-256
							</span>
						</div>

						<!-- Game Info -->
						<div class="card-body d-flex flex-column">
							<h5 class="card-title fw-bold" th:text="${game.product.title}"></h5>
							<p class="card-text text-muted small mb-2">
								<i class="fa-solid fa-tag me-1"></i> [[${game.product.category}]]
							</p>
							<p class="card-text text-muted small mb-3" 
								th:text="${#strings.abbreviate(game.product.description, 100)}"></p>

							<!-- üîë License Key Section -->
							<div class="mb-3" th:if="${game.gameKey != null}">
								<label class="form-label small fw-bold mb-1" style="color: #d4a017;">
									<i class="fa-solid fa-key me-1"></i> License Key (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå)
								</label>
								<div class="input-group input-group-sm">
									<input type="password" class="form-control font-monospace bg-light" 
										th:id="'key-' + ${game.id}"
										th:value="${game.gameKey}" readonly
										style="letter-spacing: 1px;">
									<!-- Toggle visibility -->
									<button class="btn btn-outline-warning" type="button"
										th:onclick="'toggleKey(' + ${game.id} + ', this)'"
										title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Key">
										<i class="fa-solid fa-eye"></i>
									</button>
									<!-- Copy button -->
									<button class="btn btn-outline-secondary" type="button"
										th:onclick="'copyKey(' + ${game.id} + ', this)'"
										title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Key">
										<i class="fa-solid fa-copy"></i>
									</button>
								</div>
								<small class="text-muted mt-1 d-block">
									<i class="fa-solid fa-info-circle me-1"></i> ‡πÉ‡∏ä‡πâ Key ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå ZIP
								</small>
							</div>

							<!-- Purchase Info -->
							<div class="mb-3 small text-muted">
								<div><i class="fa-solid fa-calendar me-1"></i> Purchased: 
									<span th:text="${#temporals.format(game.purchaseDate, 'dd/MM/yyyy HH:mm')}"></span>
								</div>
								<div th:if="${game.product.fileSize}">
									<i class="fa-solid fa-hard-drive me-1"></i> Size: [[${game.product.fileSize}]]
								</div>
								<div th:if="${game.isDownloaded}">
									<span class="text-success"><i class="fa-solid fa-check me-1"></i> Downloaded</span>
								</div>
							</div>

							<!-- üîê Secure Download Button -->
							<div class="mt-auto">
								<!-- ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏° ‚Üí Secure Download (AES-256 Encrypted ZIP) -->
								<th:block th:if="${game.product.gameFilePath != null and game.product.downloadLink == 'SECURE_DOWNLOAD_AVAILABLE'}">
									<a th:href="'/user/game-library/secure-download/' + ${game.id}" 
										class="btn btn-primary w-100 mb-2"
										onclick="showDownloadGuide(this)">
										<i class="fa-solid fa-shield-halved me-2"></i>
										<span th:if="${game.isDownloaded}">Download Again (Encrypted)</span>
										<span th:unless="${game.isDownloaded}"><i class="fa-solid fa-download me-1"></i> Secure Download</span>
									</a>
								</th:block>

								<!-- ‡∏°‡∏µ downloadLink ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (fallback) -->
								<th:block th:if="${(game.product.gameFilePath == null or game.product.downloadLink != 'SECURE_DOWNLOAD_AVAILABLE') and game.product.downloadLink != null and game.product.downloadLink != '' and game.product.downloadLink != 'SECURE_DOWNLOAD_AVAILABLE'}">
									<a th:href="${game.product.downloadLink}" 
										class="btn btn-primary w-100"
										target="_blank"
										th:onclick="'fetch(\'/user/game-library/download/' + ${game.id} + '\')'">
										<i class="fa-solid fa-download me-2"></i> 
										<span th:if="${game.isDownloaded}">Download Again</span>
										<span th:unless="${game.isDownloaded}">Download</span>
									</a>
								</th:block>

								<!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î -->
								<th:block th:if="${(game.product.gameFilePath == null or game.product.downloadLink != 'SECURE_DOWNLOAD_AVAILABLE') and (game.product.downloadLink == null or game.product.downloadLink == '')}">
									<button class="btn btn-secondary w-100" disabled>
										<i class="fa-solid fa-clock me-2"></i> Download Coming Soon
									</button>
								</th:block>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- üìñ How to Use Guide -->
			<div class="card border-0 shadow-sm mt-5" th:if="${games != null and !games.isEmpty()}" style="border-radius: 12px;">
				<div class="card-body p-4">
					<h5 class="fw-bold mb-3"><i class="fa-solid fa-circle-question me-2 text-primary"></i>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</h5>
					<div class="row g-3">
						<div class="col-md-3 text-center">
							<div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 56px; height: 56px;">
								<span class="fw-bold text-primary fs-5">1</span>
							</div>
							<p class="small mb-0">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>Secure Download</strong></p>
						</div>
						<div class="col-md-3 text-center">
							<div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 56px; height: 56px;">
								<span class="fw-bold text-primary fs-5">2</span>
							</div>
							<p class="small mb-0">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå <strong>*_Locked.zip</strong></p>
						</div>
						<div class="col-md-3 text-center">
							<div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 56px; height: 56px;">
								<span class="fw-bold text-primary fs-5">3</span>
							</div>
							<p class="small mb-0">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ <strong>WinRAR / 7-Zip</strong></p>
						</div>
						<div class="col-md-3 text-center">
							<div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 56px; height: 56px;">
								<span class="fw-bold text-primary fs-5">4</span>
							</div>
							<p class="small mb-0">‡∏Å‡∏£‡∏≠‡∏Å <strong>License Key</strong> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Browse More -->
			<div class="text-center mt-4" th:if="${games != null and !games.isEmpty()}">
				<a href="/products" class="btn btn-outline-primary btn-lg">
					<i class="fa-solid fa-store me-2"></i> Browse More Games
				</a>
			</div>
		</div>

		<!-- Download Guide Modal -->
		<div class="modal fade" id="downloadGuideModal" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content" style="border-radius: 16px;">
					<div class="modal-header border-0 pb-0">
						<h5 class="modal-title fw-bold">
							<i class="fa-solid fa-shield-halved text-primary me-2"></i>Secure Download Started
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div class="alert alert-success mb-3">
							<i class="fa-solid fa-check-circle me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ AES-256...
						</div>
						<div class="bg-light p-3 rounded">
							<p class="mb-2 small"><strong>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à:</strong></p>
							<ol class="small mb-0">
								<li>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå <code>*_Locked.zip</code> ‡∏î‡πâ‡∏ß‡∏¢ WinRAR ‡∏´‡∏£‡∏∑‡∏≠ 7-Zip</li>
								<li>‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</li>
								<li>‡∏Å‡∏£‡∏≠‡∏Å <strong>License Key</strong> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)</li>
								<li>‡πÅ‡∏ï‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</li>
							</ol>
						</div>
					</div>
					<div class="modal-footer border-0">
						<button type="button" class="btn btn-primary" data-bs-dismiss="modal">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß!</button>
					</div>
				</div>
			</div>
		</div>

		<!-- JavaScript for Key management -->
		<script th:inline="javascript">
			// Toggle License Key visibility
			function toggleKey(gameId, btn) {
				var input = document.getElementById('key-' + gameId);
				if (input.type === 'password') {
					input.type = 'text';
					btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
				} else {
					input.type = 'password';
					btn.innerHTML = '<i class="fa-solid fa-eye"></i>';
				}
			}

			// Copy License Key to clipboard
			function copyKey(gameId, btn) {
				var input = document.getElementById('key-' + gameId);
				navigator.clipboard.writeText(input.value).then(function() {
					btn.innerHTML = '<i class="fa-solid fa-check text-success"></i>';
					setTimeout(function() {
						btn.innerHTML = '<i class="fa-solid fa-copy"></i>';
					}, 2000);
				});
			}

			// Show download guide modal
			function showDownloadGuide(btn) {
				var modal = new bootstrap.Modal(document.getElementById('downloadGuideModal'));
				modal.show();
			}
		</script>
	</section>
</body>
</html>
