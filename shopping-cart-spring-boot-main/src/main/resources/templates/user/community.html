<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Community</title>
</head>
<body>
	<section>
		<div class="container mt-5">
			<div class="row">
				<div class="col-md-8 offset-md-2">
					<h3 class="text-center mb-4">Community Feed</h3>
					
					<style>
						.avatar-img {
							width: 45px;
							height: 45px;
							border-radius: 50%;
							object-fit: cover;
						}
						.avatar-sm {
							width: 35px;
							height: 35px;
						}
						.comment-bubble {
							background-color: #f0f2f5;
							border-radius: 18px;
							padding: 8px 15px;
							display: inline-block;
							max-width: 100%;
						}
						.reply-bubble {
							background-color: #e4e6eb;
						}
						.post-card {
							border-radius: 12px;
							border: none;
							box-shadow: 0 1px 2px rgba(0,0,0,0.1);
						}
					</style>

					<!-- Create Post Form -->
					<div class="card post-card mb-4">
						<div class="card-body">
							<div class="d-flex gap-2">
								<img th:src="${user.profileImage != null && #strings.startsWith(user.profileImage, 'http') ? user.profileImage : '/img/profile_img/' + user.profileImage}" 
													 class="avatar-img" alt="My Profile" onerror="this.src='/img/profile_img/default.png'">
								<form action="/user/community/post" method="post" class="flex-grow-1">
									<div class="mb-3">
										<textarea name="content" class="form-control" rows="2" 
												  style="border-radius: 20px; background-color: #f0f2f5; border: none; padding: 10px 20px;"
												  placeholder="What's on your mind?" required></textarea>
									</div>
									<div class="text-end">
										<button type="submit" class="btn btn-primary rounded-pill px-4">Post</button>
									</div>
								</form>
							</div>
						</div>
					</div>

					<!-- Posts Feed -->
					<div th:each="post : ${posts}" class="card post-card mb-4" th:id="'post-' + ${post.id}">
						<div class="card-body">
							<div class="d-flex justify-content-between align-items-center mb-3">
								<div class="d-flex align-items-center gap-2">
									<img th:src="${post.author.profileImage != null && #strings.startsWith(post.author.profileImage, 'http') ? post.author.profileImage : '/img/profile_img/' + post.author.profileImage}" 
														 class="avatar-img" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
									<div>
										<h6 class="mb-0 fw-bold" th:text="${post.author.name}">Author</h6>
										<small class="text-muted" th:text="${#temporals.format(post.createdAt, 'dd MMMM yyyy HH:mm')}">Date</small>
									</div>
								</div>
								<!-- Edit/Delete dropdown for post owner -->
								<div class="dropdown" th:if="${user.id == post.author.id}">
									<button class="btn btn-sm btn-light border-0 dropdown-toggle no-caret" type="button"
										data-bs-toggle="dropdown" aria-expanded="false">
										<i class="fa-solid fa-ellipsis"></i>
									</button>
									<ul class="dropdown-menu dropdown-menu-end">
										<li>
											<a class="dropdown-item" th:href="@{'/user/community/post/' + ${post.id} + '/edit'}">
												<i class="fa-solid fa-pen me-2"></i> Edit
											</a>
										</li>
										<li>
											<form th:action="@{'/user/community/post/' + ${post.id} + '/delete'}" method="post"
												  onsubmit="return confirm('Are you sure you want to delete this post?');">
												<button type="submit" class="dropdown-item text-danger">
													<i class="fa-solid fa-trash me-2"></i> Delete
												</button>
											</form>
										</li>
									</ul>
								</div>
							</div>
							
							<!-- Clickable post content -->
							<a th:href="@{'/user/community/post/' + ${post.id}}" class="text-decoration-none text-dark">
								<p class="card-text fs-5" th:text="${post.content}">Content</p>
							</a>
							
							<div class="d-flex justify-content-between align-items-center mb-2 px-1">
								<small class="text-muted">
									<i class="fa-solid fa-thumbs-up text-primary"></i> 
									<span class="like-count" th:text="${post.likes.size()}">0</span>
								</small>
								<small class="text-muted">
									<span th:text="${post.comments.size()}">0</span> Comments
								</small>
							</div>
							
							<hr class="my-2">
							
							<div class="d-flex gap-1">
								<button class="btn btn-light flex-grow-1 like-btn border-0" 
										th:classappend="${post.likes.?[user.id == #vars.user.id].size() > 0 ? 'text-primary' : ''}"
										th:data-post-id="${post.id}"
										onclick="toggleLike(this)">
									<i class="fa-thumbs-up" th:classappend="${post.likes.?[user.id == #vars.user.id].size() > 0 ? 'fa-solid' : 'fa-regular'}"></i> 
									<span class="fw-bold">Like</span>
								</button>
								<button class="btn btn-light flex-grow-1 border-0" 
										type="button" 
										data-bs-toggle="collapse" 
										th:data-bs-target="'#comments-' + ${post.id}">
									<i class="fa-regular fa-comment"></i> 
									<span class="fw-bold">Comment</span>
								</button>
							</div>
							
							<!-- Comments Section -->
							<div class="collapse mt-3" th:id="'comments-' + ${post.id}">
								<div class="px-1 py-2">
									<!-- Comment List -->
									<div th:each="comment : ${post.comments}">
										<!-- Only show top-level comments (no parent) -->
										<div th:if="${comment.parentComment == null}" class="d-flex gap-2 mb-3">
											<img th:src="${comment.author.profileImage != null && #strings.startsWith(comment.author.profileImage, 'http') ? comment.author.profileImage : '/img/profile_img/' + comment.author.profileImage}" 
																 class="avatar-img avatar-sm mt-1" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
											<div class="flex-grow-1">
												<div class="comment-bubble">
													<div class="d-flex justify-content-between align-items-center gap-3">
														<strong class="small" th:text="${comment.author.name}">User</strong>
														<!-- Admin/Owner Options -->
														<div class="dropdown" th:if="${user.id == comment.author.id}">
															<button class="btn btn-sm btn-link text-muted p-0 no-caret" type="button" data-bs-toggle="dropdown">
																<i class="fa-solid fa-ellipsis-vertical small"></i>
															</button>
															<ul class="dropdown-menu dropdown-menu-end small">
																<li><a class="dropdown-item" href="#" th:onclick="'editComment(' + ${comment.id} + ', this)'" th:data-content="${comment.content}">Edit</a></li>
																<li>
																	<form th:action="@{'/user/community/comment/' + ${comment.id} + '/delete'}" method="post" onsubmit="return confirm('Delete this comment?');">
																		<button type="submit" class="dropdown-item text-danger">Delete</button>
																	</form>
																</li>
															</ul>
														</div>
													</div>
													<p class="mb-0 small" th:id="'comment-text-' + ${comment.id}" th:text="${comment.content}">Comment</p>
													
													<!-- Inline edit form -->
													<div class="d-none mt-1" th:id="'comment-edit-' + ${comment.id}">
														<form th:action="@{'/user/community/comment/' + ${comment.id} + '/edit'}" method="post" class="d-flex">
															<input type="text" name="content" class="form-control form-control-sm me-2 rounded-pill" th:value="${comment.content}" required>
															<button type="submit" class="btn btn-sm btn-primary rounded-pill">Save</button>
														</form>
													</div>
												</div>
												<div class="ms-2">
													<small class="text-muted pointer reply-btn me-2" data-bs-toggle="collapse" th:data-bs-target="'#reply-form-' + ${comment.id}">Reply</small>
													<small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'dd-MM-yyyy HH:mm')}">Date</small>
												</div>

												<!-- Reply form -->
												<div class="collapse mt-2 ms-2" th:id="'reply-form-' + ${comment.id}">
													<div class="d-flex gap-2">
														<img th:src="${user.profileImage != null && #strings.startsWith(user.profileImage, 'http') ? user.profileImage : '/img/profile_img/' + user.profileImage}" 
																			 class="avatar-img avatar-sm" alt="My Profile" onerror="this.src='/img/profile_img/default.png'">
														<form action="/user/community/reply" method="post" class="flex-grow-1 d-flex">
															<input type="hidden" name="parentCommentId" th:value="${comment.id}">
															<input type="text" name="content" class="form-control form-control-sm me-2 rounded-pill bg-white border" th:placeholder="'Reply to ' + ${comment.author.name} + '...'" required>
															<button type="submit" class="btn btn-sm btn-primary rounded-pill"><i class="fa-solid fa-paper-plane"></i></button>
														</form>
													</div>
												</div>

												<!-- Replies (Nested) -->
												<div th:if="${!comment.replies.isEmpty()}" class="mt-2 ms-2">
													<div th:each="reply : ${comment.replies}" class="d-flex gap-2 mb-2">
														<img th:src="${reply.author.profileImage != null && #strings.startsWith(reply.author.profileImage, 'http') ? reply.author.profileImage : '/img/profile_img/' + reply.author.profileImage}" 
																			 class="avatar-img avatar-sm" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
														<div class="flex-grow-1">
															<div class="comment-bubble reply-bubble">
																<div class="d-flex justify-content-between align-items-center gap-3">
																	<strong class="small" th:text="${reply.author.name}">User</strong>
																	<div class="dropdown" th:if="${user.id == reply.author.id}">
																		<button class="btn btn-sm btn-link text-muted p-0 no-caret" type="button" data-bs-toggle="dropdown">
																			<i class="fa-solid fa-ellipsis-vertical small"></i>
																		</button>
																		<ul class="dropdown-menu dropdown-menu-end small">
																			<li><a class="dropdown-item" href="#" th:onclick="'editComment(' + ${reply.id} + ', this)'" th:data-content="${reply.content}">Edit</a></li>
																			<li>
																				<form th:action="@{'/user/community/comment/' + ${reply.id} + '/delete'}" method="post" onsubmit="return confirm('Delete this reply?');">
																					<button type="submit" class="dropdown-item text-danger">Delete</button>
																				</form>
																			</li>
																		</ul>
																	</div>
																</div>
																<p class="mb-0 small" th:id="'comment-text-' + ${reply.id}" th:text="${reply.content}">Reply</p>
																<!-- Inline edit form for reply -->
																<div class="d-none mt-1" th:id="'comment-edit-' + ${reply.id}">
																	<form th:action="@{'/user/community/comment/' + ${reply.id} + '/edit'}" method="post" class="d-flex">
																		<input type="text" name="content" class="form-control form-control-sm me-2 rounded-pill" th:value="${reply.content}" required>
																		<button type="submit" class="btn btn-sm btn-primary rounded-pill">Save</button>
																	</form>
																</div>
															</div>
															<div class="ms-2">
																<small class="text-muted" th:text="${#temporals.format(reply.createdAt, 'dd-MM-yyyy HH:mm')}">Date</small>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>

									<!-- Add Primary Comment Form -->
									<div class="d-flex gap-2 mt-3 pt-2 border-top">
										<img th:src="${user.profileImage != null && #strings.startsWith(user.profileImage, 'http') ? user.profileImage : '/img/profile_img/' + user.profileImage}" 
															 class="avatar-img avatar-sm" alt="My Profile" onerror="this.src='/img/profile_img/default.png'">
										<form action="/user/community/comment" method="post" class="flex-grow-1 d-flex">
											<input type="hidden" name="postId" th:value="${post.id}">
											<input type="text" name="content" class="form-control me-2 rounded-pill bg-white border" placeholder="Write a comment..." required>
											<button type="submit" class="btn btn-sm btn-primary rounded-circle" style="width: 32px; height: 32px; padding: 0;">
												<i class="fa-solid fa-paper-plane"></i>
											</button>
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

		<script>
			function toggleLike(btn) {
				const postId = btn.getAttribute('data-post-id');
				btn.disabled = true;
				fetch('/user/community/like?postId=' + postId, {
					method: 'POST',
					credentials: 'include',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
				})
				.then(response => {
					if (!response.ok) throw new Error('Error: ' + response.status);
					return response.json();
				})
				.then(data => {
					// Find like count in the post card
					const postCard = document.getElementById('post-' + postId);
					const likeCountSpan = postCard.querySelector('.like-count');
					if (likeCountSpan) likeCountSpan.textContent = data.likeCount;
					
					// Toggle button styling
					const icon = btn.querySelector('i');
					if (data.liked) {
						btn.classList.add('text-primary');
						icon.classList.remove('fa-regular');
						icon.classList.add('fa-solid');
					} else {
						btn.classList.remove('text-primary');
						icon.classList.remove('fa-solid');
						icon.classList.add('fa-regular');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('ไม่สามารถกดไลค์ได้ กรุณาลองใหม่อีกครั้ง');
				})
				.finally(() => { btn.disabled = false; });
			}

			function editComment(commentId, el) {
				document.getElementById('comment-text-' + commentId).classList.add('d-none');
				document.getElementById('comment-edit-' + commentId).classList.remove('d-none');
			}

			function cancelEditComment(commentId) {
				document.getElementById('comment-text-' + commentId).classList.remove('d-none');
				document.getElementById('comment-edit-' + commentId).classList.add('d-none');
			}
		</script>
	</section>
</body>
</html>