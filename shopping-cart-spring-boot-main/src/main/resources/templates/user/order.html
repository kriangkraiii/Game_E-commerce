<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Checkout</title>
</head>
<body>
	<section>
		<div class="container mt-5 p-4" style="max-width: 700px;">
			
			<!-- Progress Steps -->
			<div class="d-flex justify-content-center align-items-center mb-4" id="progressSteps">
				<div class="text-center">
					<div class="rounded-circle d-flex align-items-center justify-content-center bg-primary text-white" style="width: 40px; height: 40px; margin: 0 auto;">
						<i class="fas fa-receipt"></i>
					</div>
					<small class="d-block mt-1 fw-bold text-primary">Review</small>
				</div>
				<div class="flex-grow-0 mx-3" style="height: 2px; width: 60px; background: #dee2e6;"></div>
				<div class="text-center" id="stepConfirm">
					<div class="rounded-circle d-flex align-items-center justify-content-center bg-secondary text-white" style="width: 40px; height: 40px; margin: 0 auto;" id="stepConfirmCircle">
						<i class="fas fa-shield-halved"></i>
					</div>
					<small class="d-block mt-1 text-muted" id="stepConfirmText">Confirm</small>
				</div>
				<div class="flex-grow-0 mx-3" style="height: 2px; width: 60px; background: #dee2e6;" id="progressLine2"></div>
				<div class="text-center" id="stepComplete">
					<div class="rounded-circle d-flex align-items-center justify-content-center bg-secondary text-white" style="width: 40px; height: 40px; margin: 0 auto;" id="stepCompleteCircle">
						<i class="fas fa-check"></i>
					</div>
					<small class="d-block mt-1 text-muted" id="stepCompleteText">Complete</small>
				</div>
			</div>

			<!-- Step 1: Order Review -->
			<div id="reviewStep">
				<div class="card shadow-sm border-0" style="border-radius: 12px;">
					<div class="card-header text-center bg-white border-bottom py-3">
						<h5 class="mb-0 fw-bold"><i class="fa-solid fa-receipt me-2 text-primary"></i>Order Review</h5>
					</div>
					<div class="card-body p-4">
						<th:block th:if="${session.errorMsg}">
							<div class="alert alert-danger text-center" role="alert">
								<i class="fas fa-exclamation-circle me-1"></i>[[${session.errorMsg}]]
							</div>
							<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
						</th:block>

						<!-- Items -->
						<div class="mb-4">
							<h6 class="text-muted mb-3"><i class="fas fa-gamepad me-1"></i> Items</h6>
							<div th:each="cart : ${carts}" class="d-flex align-items-center p-3 mb-2 bg-light rounded">
								<img th:src="${cart.product.image}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
								<div class="flex-grow-1">
									<span class="fw-bold" th:text="${cart.product.title}"></span>
								</div>
								<span class="fw-bold text-primary">
									<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
									<span th:text="${#numbers.formatDecimal(cart.product.discountPrice, 1, 2)}"></span>
								</span>
							</div>
						</div>

						<!-- Summary -->
						<div class="border-top pt-3">
							<div class="d-flex justify-content-between mb-2">
								<span class="text-muted">Subtotal</span>
								<span class="fw-bold">
									<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
									<span th:text="${#numbers.formatDecimal(totalOrderPrice, 1, 2)}"></span>
								</span>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<span class="text-muted"><i class="fas fa-wallet me-1"></i> Wallet Balance</span>
								<span class="fw-bold" th:classappend="${walletBalance >= totalOrderPrice} ? 'text-success' : 'text-danger'">
									<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
									<span th:text="${#numbers.formatDecimal(walletBalance, 1, 2)}"></span>
								</span>
							</div>
							<hr>
							<div class="d-flex justify-content-between">
								<span class="fw-bold fs-5">Total</span>
								<span class="fw-bold fs-5 text-primary">
									<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
									<span th:text="${#numbers.formatDecimal(totalOrderPrice, 1, 2)}"></span>
								</span>
							</div>
							<div class="d-flex justify-content-between mt-1">
								<span class="text-muted small">After Purchase</span>
								<span class="fw-bold" th:classappend="${walletBalance >= totalOrderPrice} ? 'text-success' : 'text-danger'">
									<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
									<span th:text="${#numbers.formatDecimal(walletBalance - totalOrderPrice, 1, 2)}"></span>
								</span>
							</div>
						</div>

						<!-- Actions -->
						<div class="mt-4">
							<th:block th:if="${walletBalance >= totalOrderPrice}">
								<button type="button" class="btn btn-primary btn-lg w-100 mb-2" id="proceedToConfirm" style="border-radius: 10px;">
									<i class="fa-solid fa-arrow-right me-2"></i>Proceed to Confirm
								</button>
							</th:block>
							<th:block th:unless="${walletBalance >= totalOrderPrice}">
								<div class="alert alert-warning text-center mb-3">
									<i class="fa-solid fa-triangle-exclamation me-2"></i>
									<strong>Insufficient Balance!</strong><br>
									<small>You need <th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block><span th:text="${#numbers.formatDecimal(totalOrderPrice - walletBalance, 1, 2)}"></span> more.</small>
								</div>
								<a href="/user/wallet" class="btn btn-primary btn-lg w-100 mb-2" style="border-radius: 10px;">
									<i class="fa-solid fa-plus-circle me-2"></i>Top Up Wallet
								</a>
							</th:block>
							<a href="/user/cart" class="btn btn-outline-secondary w-100" style="border-radius: 10px;">
								<i class="fa-solid fa-arrow-left me-2"></i>Back to Cart
							</a>
						</div>
					</div>
				</div>
			</div>

			<!-- Step 2: Confirmation -->
			<div id="confirmStep" style="display: none;">
				<div class="card shadow-sm border-0" style="border-radius: 12px;">
					<div class="card-body p-4 text-center">
						<div class="mb-4">
							<div class="rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; background: #fff3cd;">
								<i class="fas fa-shield-halved fa-2x text-warning"></i>
							</div>
						</div>
						<h5 class="fw-bold mb-2">Confirm Payment</h5>
						<p class="text-muted mb-4">Please confirm to deduct 
							<strong class="text-primary">
								<th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block>
								<span th:text="${#numbers.formatDecimal(totalOrderPrice, 1, 2)}"></span>
							</strong> 
							from your wallet.
						</p>

						<div class="bg-light rounded p-3 mb-4 text-start" style="max-width: 350px; margin: 0 auto;">
							<div class="d-flex justify-content-between mb-1">
								<small class="text-muted">Amount</small>
								<small class="fw-bold"><th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block> <span th:text="${#numbers.formatDecimal(totalOrderPrice, 1, 2)}"></span></small>
							</div>
							<div class="d-flex justify-content-between mb-1">
								<small class="text-muted">Payment</small>
								<small class="fw-bold">Wallet</small>
							</div>
							<div class="d-flex justify-content-between">
								<small class="text-muted">Remaining Balance</small>
								<small class="fw-bold text-success"><th:block th:utext="${@commnServiceImpl.bahtSign()}"></th:block> <span th:text="${#numbers.formatDecimal(walletBalance - totalOrderPrice, 1, 2)}"></span></small>
							</div>
						</div>

						<form action="/user/save-order" method="post" id="orderForm">
							<input type="hidden" name="paymentType" value="WALLET">
							<button type="submit" class="btn btn-success btn-lg w-100 mb-2" id="confirmPayBtn" style="border-radius: 10px;">
								<i class="fa-solid fa-check-circle me-2"></i>Confirm Purchase
							</button>
						</form>
						<button type="button" class="btn btn-outline-secondary w-100" id="backToReview" style="border-radius: 10px;">
							<i class="fa-solid fa-arrow-left me-2"></i>Back
						</button>
					</div>
				</div>
			</div>

			<!-- Step 3: Processing overlay -->
			<div id="processingStep" style="display: none;">
				<div class="card shadow-sm border-0 text-center p-5" style="border-radius: 12px;">
					<div class="spinner-border text-primary mx-auto mb-3" style="width: 3rem; height: 3rem;" role="status">
						<span class="visually-hidden">Processing...</span>
					</div>
					<h5 class="fw-bold">Processing Payment...</h5>
					<p class="text-muted">Please wait while we process your order.</p>
				</div>
			</div>

		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const reviewStep = document.getElementById('reviewStep');
				const confirmStep = document.getElementById('confirmStep');
				const processingStep = document.getElementById('processingStep');
				const proceedBtn = document.getElementById('proceedToConfirm');
				const backBtn = document.getElementById('backToReview');
				const orderForm = document.getElementById('orderForm');
				const confirmPayBtn = document.getElementById('confirmPayBtn');
				const stepConfirmCircle = document.getElementById('stepConfirmCircle');
				const stepConfirmText = document.getElementById('stepConfirmText');
				const stepCompleteCircle = document.getElementById('stepCompleteCircle');
				const stepCompleteText = document.getElementById('stepCompleteText');

				if (proceedBtn) {
					proceedBtn.addEventListener('click', function() {
						reviewStep.style.display = 'none';
						confirmStep.style.display = 'block';
						stepConfirmCircle.classList.remove('bg-secondary');
						stepConfirmCircle.classList.add('bg-primary');
						stepConfirmText.classList.remove('text-muted');
						stepConfirmText.classList.add('fw-bold', 'text-primary');
					});
				}

				if (backBtn) {
					backBtn.addEventListener('click', function() {
						confirmStep.style.display = 'none';
						reviewStep.style.display = 'block';
						stepConfirmCircle.classList.add('bg-secondary');
						stepConfirmCircle.classList.remove('bg-primary');
						stepConfirmText.classList.add('text-muted');
						stepConfirmText.classList.remove('fw-bold', 'text-primary');
					});
				}

				if (orderForm) {
					orderForm.addEventListener('submit', function() {
						confirmStep.style.display = 'none';
						processingStep.style.display = 'block';
						confirmPayBtn.disabled = true;
						stepCompleteCircle.classList.remove('bg-secondary');
						stepCompleteCircle.classList.add('bg-primary');
						stepCompleteText.classList.remove('text-muted');
						stepCompleteText.classList.add('fw-bold', 'text-primary');
					});
				}
			});
		</script>
	</section>
</body>
</html>
