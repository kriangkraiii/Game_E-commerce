<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Admin Community Management</title>
</head>
<body>
	<section>
		<div class="container mt-5">
			<div class="row">
				<div class="col-md-8 offset-md-2">
					<h3 class="text-center mb-4 text-danger">
                        <i class="fa-solid fa-user-shield me-2"></i>Admin Community Management
                    </h3>
					
					<style>
						.avatar-img {
							width: 45px;
							height: 45px;
							border-radius: 50%;
							object-fit: cover;
						}
						.avatar-sm {
							width: 35px;
							height: 35px;
						}
						.comment-bubble {
							background-color: #f0f2f5;
							border-radius: 18px;
							padding: 8px 15px;
							display: inline-block;
							max-width: 100%;
						}
						.post-card {
							border-radius: 12px;
							border: none;
							box-shadow: 0 1px 2px rgba(0,0,0,0.1);
						}
					</style>
					
					<!-- Posts Feed -->
					<div th:each="post : ${posts}" class="card post-card shadow-sm mb-4" th:id="'post-' + ${post.id}">
						<div class="card-body">
							<div class="d-flex justify-content-between align-items-center mb-3">
								<div class="d-flex align-items-center gap-2">
									<img th:src="${post.author.profileImage != null && #strings.startsWith(post.author.profileImage, 'http') ? post.author.profileImage : '/img/profile_img/' + post.author.profileImage}" 
														 class="avatar-img" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
									<div>
										<h6 class="mb-0 fw-bold">
											<span th:text="${post.author.name}">Author</span>
											<span class="badge bg-danger ms-2 small" th:text="${post.author.role}">ROLE</span>
										</h6>
										<small class="text-muted" th:text="${#temporals.format(post.createdAt, 'dd MMMM yyyy HH:mm')}">Date</small>
									</div>
								</div>
								
								<!-- Admin Actions -->
								<div class="dropdown">
									<button class="btn btn-sm btn-outline-danger dropdown-toggle rounded-pill" type="button"
										data-bs-toggle="dropdown" aria-expanded="false">
										<i class="fa-solid fa-gear"></i> Admin
									</button>
									<ul class="dropdown-menu dropdown-menu-end shadow">
										<li>
											<a class="dropdown-item" th:href="@{'/admin/community/post/' + ${post.id} + '/edit'}">
												<i class="fa-solid fa-pen me-2"></i> Edit Post
											</a>
										</li>
										<li>
											<form th:action="@{'/admin/community/post/' + ${post.id} + '/delete'}" method="post"
												  onsubmit="return confirm('ADMIN ACTION: Are you sure you want to delete this post?');">
												<button type="submit" class="dropdown-item text-danger">
													<i class="fa-solid fa-trash me-2"></i> Delete Post
												</button>
											</form>
										</li>
									</ul>
								</div>
							</div>
							
							<p class="card-text fs-5" th:text="${post.content}">Content</p>
							
							<div class="d-flex justify-content-between align-items-center mb-2 px-1">
								<small class="text-muted">
									<i class="fa-solid fa-thumbs-up text-primary"></i> 
									<span th:text="${post.likes.size()}">0</span> Likes
								</small>
								<button class="btn btn-link btn-sm text-muted text-decoration-none p-0" 
										type="button" 
										data-bs-toggle="collapse" 
										th:data-bs-target="'#comments-' + ${post.id}">
									<span th:text="${post.comments.size()}">0</span> Comments
								</button>
							</div>
							
							<!-- Comments Section -->
							<div class="collapse mt-3" th:id="'comments-' + ${post.id}">
								<div class="px-1 py-1">
									<div th:each="comment : ${post.comments}">
										<div th:if="${comment.parentComment == null}" class="d-flex gap-2 mb-3">
											<img th:src="${comment.author.profileImage != null && #strings.startsWith(comment.author.profileImage, 'http') ? comment.author.profileImage : '/img/profile_img/' + comment.author.profileImage}" 
																 class="avatar-img avatar-sm mt-1" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
											<div class="flex-grow-1">
												<div class="comment-bubble">
													<div class="d-flex justify-content-between align-items-center gap-3">
														<strong class="small" th:text="${comment.author.name}">User</strong>
														<!-- Admin Comment Actions -->
														<div class="dropdown">
															<button class="btn btn-sm btn-link text-danger p-0 no-caret" type="button" data-bs-toggle="dropdown">
																<i class="fa-solid fa-ellipsis-vertical small"></i>
															</button>
															<ul class="dropdown-menu dropdown-menu-end small shadow">
																<li>
																	<a class="dropdown-item" href="#" th:onclick="'editComment(' + ${comment.id} + ', this)'" th:data-content="${comment.content}">
																		<i class="fa-solid fa-pen me-2"></i> Edit
																	</a>
																</li>
																<li>
																	<form th:action="@{'/admin/community/comment/' + ${comment.id} + '/delete'}" method="post" onsubmit="return confirm('ADMIN: Delete this comment?');">
																		<button type="submit" class="dropdown-item text-danger">
																			<i class="fa-solid fa-trash me-2"></i> Delete
																		</button>
																	</form>
																</li>
															</ul>
														</div>
													</div>
													<p class="mb-0 small" th:id="'comment-text-' + ${comment.id}" th:text="${comment.content}">Comment</p>
													
													<!-- Inline edit form -->
													<div class="d-none mt-1" th:id="'comment-edit-' + ${comment.id}">
														<form th:action="@{'/admin/community/comment/' + ${comment.id} + '/edit'}" method="post" class="d-flex">
															<input type="text" name="content" class="form-control form-control-sm me-2 rounded-pill" th:value="${comment.content}" required>
															<button type="submit" class="btn btn-sm btn-primary rounded-pill">Save</button>
														</form>
													</div>
												</div>
												<div class="ms-2">
													<small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'dd-MM-yyyy HH:mm')}">Date</small>
												</div>
												
												<!-- Child Replies (No action needed here usually but admin might see) -->
												<div th:if="${!comment.replies.isEmpty()}" class="mt-2">
													<div th:each="reply : ${comment.replies}" class="d-flex gap-2 mb-2">
														<img th:src="${reply.author.profileImage != null && #strings.startsWith(reply.author.profileImage, 'http') ? reply.author.profileImage : '/img/profile_img/' + reply.author.profileImage}" 
																			 class="avatar-img avatar-sm" alt="Profile" onerror="this.src='/img/profile_img/default.png'">
														<div class="flex-grow-1">
															<div class="comment-bubble" style="background-color: #e4e6eb;">
																<div class="d-flex justify-content-between align-items-center gap-3">
																	<strong class="small" th:text="${reply.author.name}">User</strong>
																	<!-- Admin Reply Actions -->
																	<div class="dropdown">
																		<button class="btn btn-sm btn-link text-danger p-0 no-caret" type="button" data-bs-toggle="dropdown">
																			<i class="fa-solid fa-ellipsis-vertical small"></i>
																		</button>
																		<ul class="dropdown-menu dropdown-menu-end small shadow">
																			<li>
																				<a class="dropdown-item" href="#" th:onclick="'editComment(' + ${reply.id} + ', this)'" th:data-content="${reply.content}">
																					<i class="fa-solid fa-pen me-2"></i> Edit
																				</a>
																			</li>
																			<li>
																				<form th:action="@{'/admin/community/comment/' + ${reply.id} + '/delete'}" method="post" onsubmit="return confirm('ADMIN: Delete this reply?');">
																					<button type="submit" class="dropdown-item text-danger">
																						<i class="fa-solid fa-trash me-2"></i> Delete
																					</button>
																				</form>
																			</li>
																		</ul>
																	</div>
																</div>
																<p class="mb-0 small" th:id="'comment-text-' + ${reply.id}" th:text="${reply.content}">Reply</p>
																<!-- Inline edit form for reply -->
																<div class="d-none mt-1" th:id="'comment-edit-' + ${reply.id}">
																	<form th:action="@{'/admin/community/comment/' + ${reply.id} + '/edit'}" method="post" class="d-flex">
																		<input type="text" name="content" class="form-control form-control-sm me-2 rounded-pill" th:value="${reply.content}" required>
																		<button type="submit" class="btn btn-sm btn-primary rounded-pill">Save</button>
																	</form>
																</div>
															</div>
															<div class="ms-2">
																<small class="text-muted" th:text="${#temporals.format(reply.createdAt, 'dd-MM-yyyy HH:mm')}">Date</small>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
				
				<!-- Pagination -->
				<div class="row mt-3 mb-5">
					<div class="col-md-8 offset-md-2">
						<nav aria-label="Page navigation" th:if="${totalPages > 0}">
							<ul class="pagination justify-content-center">
								<li class="page-item" th:classappend="${isFirst} ? 'disabled'">
									<a class="page-link" th:href="@{'/admin/community?pageNo=' + ${pageNo - 1}}">Previous</a>
								</li>
								
								<li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" class="page-item" 
									th:classappend="${pageNo == i} ? 'active'">
									<a class="page-link" th:href="@{'/admin/community?pageNo=' + ${i}}">[[${i + 1}]]</a>
								</li>

								<li class="page-item" th:classappend="${isLast} ? 'disabled'">
									<a class="page-link" th:href="@{'/admin/community?pageNo=' + ${pageNo + 1}}">Next</a>
								</li>
							</ul>
						</nav>
					</div>
				</div>

			</div>
		</div>

		<script>
			function editComment(commentId, el) {
				document.getElementById('comment-text-' + commentId).classList.add('d-none');
				document.getElementById('comment-edit-' + commentId).classList.remove('d-none');
			}

			function cancelEditComment(commentId) {
				document.getElementById('comment-text-' + commentId).classList.remove('d-none');
				document.getElementById('comment-edit-' + commentId).classList.add('d-none');
			}
		</script>
	</section>
</body>
</html>